#!/bin/bash

# https://support.cloudflare.com/hc/en-us/articles/200170786

########################################################################################################################

CFG=${CFG:-/etc/nginx/conf.d/10-cloudflare-real-ip-auto.conf}
URL4=https://www.cloudflare.com/ips-v4
URL6=https://www.cloudflare.com/ips-v6

# allow either command line or env variable, command line has priority
CF_REAL_IP_RECURSIVE=${1:-${CF_REAL_IP_RECURSIVE:-off}}
CF_REAL_IP_HEADER=${2:-${CF_REAL_IP_HEADER:-X-Forwarded-For}}

LOG_PREFIX="cf-real-ip:"

########################################################################################################################

echo "${LOG_PREFIX} Fetching Cloudflare IPs"
IPs=$(curl -sfL ${URL4} ${URL6})

if [ "x${IPs}" != "x" ]; then
    (
		echo -e "# This file is automatically generated by '$(basename $0)' -- $(date)"

        for ip in ${IPs}; do
            echo "set_real_ip_from ${ip};";
        done;
    ) > /tmp/cloudflare-real-ip.conf
	(
		echo -e "# This file is automatically generated by '$(basename $0)' -- $(date)"
        echo "real_ip_header    ${CF_REAL_IP_HEADER};"
        echo "real_ip_recursive ${CF_REAL_IP_RECURSIVE};"
	 ) > /etc/nginx/conf.d/10-real-ip-header-auto.conf;

    if ! $(diff -q /tmp/cloudflare-real-ip.conf ${CFG} > /dev/null 2>&1); then
        echo "${LOG_PREFIX} Updating '${CFG}'"
        cp /tmp/cloudflare-real-ip.conf ${CFG}
        pidof -s nginx && nginx -s reload &> /dev/null
    else
        echo "${LOG_PREFIX} '${CFG}' did not change"
    fi
fi

exit 0
