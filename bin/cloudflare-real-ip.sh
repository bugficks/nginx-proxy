#!/bin/bash

# https://support.cloudflare.com/hc/en-us/articles/200170786

CFG=${CFG:-/etc/nginx/conf.d/10-cloudflare-real-ip-auto.conf}
URL4=https://www.cloudflare.com/ips-v4
URL6=https://www.cloudflare.com/ips-v6

CF_REAL_IP_RECURSIVE=${1:-${CF_REAL_IP_RECURSIVE:-off}}
CF_REAL_IP_HEADER=${2:-${CF_REAL_IP_HEADER:-X-Forwarded-For}}

echo "Fetching Cloudflare IPs"
IPs=$(curl -sfL ${URL4} ${URL6})

if [ "x${IPs}" != "x" ]; then
(
    echo "# This file is automatically generated."

    for ip in ${IPs}; do
        echo "set_real_ip_from ${ip};";
    done;
    echo "real_ip_header    ${CF_REAL_IP_HEADER};"
    echo "real_ip_recursive ${CF_REAL_IP_RECURSIVE};"
) > /tmp/cloudflare-real-ip.conf

    if ! $(diff -q /tmp/cloudflare-real-ip.conf ${CFG} > /dev/null 2>&1); then
        echo "Updating ${CFG}"
        cp /tmp/cloudflare-real-ip.conf ${CFG}
        pidof -s nginx && nginx -s reload
    fi
fi

exit 0
